Assignment name  : mini_serv
Expected files   : mini_serv.c
Allowed functions: write, close, select, socket, accept, listen, send, recv, bind, strstr, malloc, realloc, free, calloc, bzero, atoi, sprintf, strlen, exit, strcpy, strcat, memset
--------------------------------------------------------------------------------

èª²é¡Œå  : mini_serv
æå‡ºãƒ•ã‚¡ã‚¤ãƒ«   : mini_serv.c
ä½¿ç”¨å¯èƒ½ãªé–¢æ•°: write, close, select, socket, accept, listen, send, recv, bind, strstr, malloc, realloc, free, calloc, bzero, atoi, sprintf, strlen, exit, strcpy, strcat, memset
--------------------------------------------------------------------------------

Write a program that will listen for client to connect on a certain port on 127.0.0.1 and will let clients to speak with each other

127.0.0.1ã®ç‰¹å®šã®ãƒãƒ¼ãƒˆã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåŒå£«ãŒä¼šè©±ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

This program will take as first argument the port to bind to
If no argument is given, it should write in stderr "Wrong number of arguments" followed by a \n and exit with status 1
If a System Calls returns an error before the program start accepting connection, it should write in stderr "Fatal error" followed by a \n and exit with status 1
If you cant allocate memory it should write in stderr "Fatal error" followed by a \n and exit with status 1

ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ç¬¬1å¼•æ•°ã¨ã—ã¦ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
å¼•æ•°ãŒä¸ãˆã‚‰ã‚Œãªã„å ´åˆã€æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã« "Wrong number of arguments" ã¨æ”¹è¡Œã‚’å‡ºåŠ›ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã—ã¾ã™ã€‚
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ¥ç¶šã®å—ã‘å…¥ã‚Œã‚’é–‹å§‹ã™ã‚‹å‰ã«ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆã€æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã« "Fatal error" ã¨æ”¹è¡Œã‚’å‡ºåŠ›ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã—ã¾ã™ã€‚
ãƒ¡ãƒ¢ãƒªã‚’å‰²ã‚Šå½“ã¦ã‚‰ã‚Œãªã„å ´åˆã€æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã« "Fatal error" ã¨æ”¹è¡Œã‚’å‡ºåŠ›ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã—ã¾ã™ã€‚

Your program must be non-blocking but client can be lazy and if they don't read your message you must NOT disconnect them...

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ€ ã‘ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¾ãªã„å ´åˆã§ã‚‚ã€åˆ‡æ–­ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“...

Your program must not contains #define preproc
Your program must only listen to 127.0.0.1
The fd that you will receive will already be set to make 'recv' or 'send' to block if select hasn't be called before calling them, but will not block otherwise.

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã¯ #define ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’å«ã‚ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ 127.0.0.1 ã®ã¿ã‚’ãƒªãƒƒã‚¹ãƒ³ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
å—ã‘å–ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã¯ã€select ã‚’å‘¼ã³å‡ºã™å‰ã« 'recv' ã‚„ 'send' ã‚’å‘¼ã³å‡ºã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ã€‚ 

When a client connect to the server:
- the client will be given an id. the first client will receive the id 0 and each new client will received the last client id + 1
- %d will be replace by this number
- a message is sent to all the client that was connected to the server: "server: client %d just arrived\n"

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ãŸå ´åˆ:
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯IDãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚æœ€åˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ID 0ã‚’å—ã‘å–ã‚Šã€ä»¥é™ã®å„æ–°è¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æœ€å¾Œã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID + 1ã‚’å—ã‘å–ã‚Šã¾ã™
- %d ã¯ã“ã®ç•ªå·ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™
- ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ãŸã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¾ã™: "server: client %d just arrived\n"

clients must be able to send messages to your program.
- message will only be printable characters, no need to check
- a single message can contains multiple \n
- when the server receive a message, it must resend it to all the other client with "client %d: " before every line!

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å°å­—å¯èƒ½æ–‡å­—ã®ã¿ã§ã™ã€ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
- 1ã¤ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¤‡æ•°ã® \n ã‚’å«ã‚€ã“ã¨ãŒã§ãã¾ã™
- ã‚µãƒ¼ãƒãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸå ´åˆã€ã™ã¹ã¦ã®ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å„è¡Œã®å‰ã« "client %d: " ã‚’ä»˜ã‘ã¦å†é€ä¿¡ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“!

When a client disconnect from the server:
- a message is sent to all the client that was connected to the server: "server: client %d just left\n"

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã—ãŸå ´åˆ:
- ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ãŸã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¾ã™: "server: client %d just left\n"

Memory or fd leaks are forbidden

ãƒ¡ãƒ¢ãƒªã‚„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã®ãƒªãƒ¼ã‚¯ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™

To help you, you will find the file main.c with the beginning of a server and maybe some useful functions. (Beware this file use forbidden functions or write things that must not be there in your final program)

ã‚µãƒãƒ¼ãƒˆã¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã®å§‹ã¾ã‚Šã¨ã„ãã¤ã‹ã®ä¾¿åˆ©ãªé–¢æ•°ãŒå«ã¾ã‚Œã‚‹ main.c ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆæ³¨æ„: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ç¦æ­¢ã•ã‚ŒãŸé–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã€æœ€çµ‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ã£ã¦ã¯ãªã‚‰ãªã„ã‚‚ã®ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ï¼‰

Warning our tester is expecting that you send the messages as fast as you can. Don't do un-necessary buffer.

è­¦å‘Š: ãƒ†ã‚¹ã‚¿ãƒ¼ã¯å¯èƒ½ãªé™ã‚Šé€Ÿããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚ä¸è¦ãªãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã‚’è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚

Evaluation can be a bit longer than usual...

è©•ä¾¡ã¯é€šå¸¸ã‚ˆã‚Šå°‘ã—é•·ãã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™...

Hint: you can use nc to test your program
Hint: you should use nc to test your program
Hint: To test you can use fcntl(fd, F_SETFL, O_NONBLOCK) but use select and NEVER check EAGAIN (man 2 send)

ãƒ’ãƒ³ãƒˆ: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ†ã‚¹ãƒˆã«ã¯ nc ã‚’ä½¿ç”¨ã§ãã¾ã™
ãƒ’ãƒ³ãƒˆ: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ†ã‚¹ãƒˆã«ã¯ nc ã‚’ä½¿ç”¨ã™ã¹ãã§ã™
ãƒ’ãƒ³ãƒˆ: ãƒ†ã‚¹ãƒˆã«ã¯ fcntl(fd, F_SETFL, O_NONBLOCK) ã‚’ä½¿ç”¨ã§ãã¾ã™ãŒã€select ã‚’ä½¿ç”¨ã—ã€EAGAIN ãƒã‚§ãƒƒã‚¯ã¯çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„ (man 2 send)


ğŸ§© èª²é¡Œå

mini_serv

ğŸ“„ æå‡ºãƒ•ã‚¡ã‚¤ãƒ«

mini_serv.c

âœ… ä½¿ç”¨å¯èƒ½ãªé–¢æ•°

write, close, select, socket, accept, listen, send, recv, bind, strstr,
malloc, realloc, free, calloc, bzero, atoi, sprintf, strlen, exit, strcpy, strcat, memset

ğŸ¯ èª²é¡Œå†…å®¹

ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ 127.0.0.1 ä¸Šã®æŒ‡å®šãƒãƒ¼ãƒˆã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’å—ã‘ä»˜ã‘ã€
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåŒå£«ãŒä¼šè©±ã§ãã‚‹ã‚µãƒ¼ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã›ã‚ˆã€‚

âš™ï¸ å®Ÿè¡Œæ–¹æ³•

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ç¬¬1å¼•æ•°ã¨ã—ã¦ ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå· ã‚’å—ã‘å–ã‚‹ã€‚

å¼•æ•°ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆ
â†’ æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«
"Wrong number of arguments\n"
ã‚’å‡ºåŠ›ã—ã€çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã™ã‚‹ã€‚

accept é–‹å§‹å‰ã®ä»»æ„ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€
"Fatal error\n" ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«å‡ºåŠ›ã—ã¦ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã€‚

ãƒ¡ãƒ¢ãƒªç¢ºä¿ã«å¤±æ•—ã—ãŸå ´åˆã‚‚ "Fatal error\n" ã‚’å‡ºã—ã¦çµ‚äº†ã™ã‚‹ã€‚

ğŸ§  æ¡ä»¶ã¨å‹•ä½œä»•æ§˜

ã‚µãƒ¼ãƒã¯ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§å‹•ä½œã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã€Œèª­ã¿å–ã‚Šã‚’ã‚µãƒœã£ã¦ã€ã‚‚ã€åˆ‡æ–­ã—ã¦ã¯ã„ã‘ãªã„ã€‚

#define ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µå‘½ä»¤ã¯ç¦æ­¢ã€‚

ã‚µãƒ¼ãƒã¯ 127.0.0.1 ã®ã¿ã‚’ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã€‚

ä¸ãˆã‚‰ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ (fd) ã¯ã€select ã‚’ä½¿ã£ã¦ã‹ã‚‰ã§ãªã‘ã‚Œã°
recv ã‚„ send ãŒãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹ï¼ˆ=selectã‚’æ­£ã—ãä½¿ã†å¿…è¦ã‚ã‚Šï¼‰ã€‚

ğŸ‘¥ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã®å‡¦ç†

å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯é †ã« IDç•ªå· ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã‚‹ã€‚
æœ€åˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ ID = 0ã€ä»¥é™ã¯ã€Œæœ€å¾Œã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID + 1ã€ã€‚

æ–°è¦æ¥ç¶šãŒã‚ã‚‹ã¨ã€ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«
"server: client %d just arrived\n"
ã‚’é€ä¿¡ã™ã‚‹ã€‚

ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å°å­—å¯èƒ½æ–‡å­—ã®ã¿ï¼ˆãƒã‚§ãƒƒã‚¯ä¸è¦ï¼‰ã€‚

1å›ã®å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã« è¤‡æ•°ã® \n ã‚’å«ã‚€å ´åˆãŒã‚ã‚‹ã€‚

ã‚µãƒ¼ãƒãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã‚‰ã€ä»–ã®å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è»¢é€ã™ã‚‹ã€‚
å„è¡Œã®å…ˆé ­ã«
"client %d: "
ã‚’ä»˜ã‘ã¦é€ã‚‹ã€‚

ğŸ”Œ åˆ‡æ–­æ™‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ‡æ–­ã—ãŸã‚‰ã€æ®‹ã‚Šã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¨å“¡ã«
"server: client %d just left\n"
ã‚’é€ä¿¡ã™ã‚‹ã€‚

ğŸš« ç¦æ­¢äº‹é …

ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ»FDãƒªãƒ¼ã‚¯ã¯ç¦æ­¢ã€‚

ä¸è¦ãªãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã¯ç¦æ­¢ï¼ˆã§ãã‚‹ã ã‘é€Ÿãé€ä¿¡ã™ã‚‹ã“ã¨ï¼‰ã€‚

ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ’ãƒ³ãƒˆ

nc ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã§ãã‚‹ã€‚

./mini_serv 8080
nc 127.0.0.1 8080


ãƒ†ã‚¹ãƒˆä¸­ã« fcntl(fd, F_SETFL, O_NONBLOCK) ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ãŒã€
å®Ÿè£…ã§ã¯ select ã‚’ç”¨ã„ã€EAGAIN ãƒã‚§ãƒƒã‚¯ã¯çµ¶å¯¾ã«ã—ã¦ã¯ã„ã‘ãªã„ã€‚